<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SubtractApp - Detect & Manage Subscriptions | Save on Recurring Charges</title>
    <meta name="description" content="Upload your bank statement (CSV or PDF) to detect potential recurring subscriptions. Review and get guidance on cancellations. Free basic tool, optional premium features.">
    <meta property="og:title" content="SubtractApp - Detect Potential Subscriptions in Your Bank Statements">
    <meta property="og:description" content="Client-side tool to find recurring charges. Average users identify $100+ in monthly potentials. 100% private.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://govosmc.github.io/subtractapp">
    <meta name="keywords" content="subscription management, cancel subscriptions, bank statement analysis, save money, personal finance">

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XXXXXXXXXX');
    </script>

    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- pdf.js for PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.mjs" type="module"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f9fafb;
            --gray: #6b7280;
            --border: #e5e7eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
        }

        /* Main Content */
        .main-content {
            margin-top: 40px;
        }

        .hero {
            text-align: center;
            color: white;
            padding: 60px 20px;
            animation: fadeInUp 0.8s ease;
        }

        .hero h1 {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .hero p {
            font-size: 20px;
            opacity: 0.95;
            max-width: 600px;
            margin: 0 auto 40px;
        }

        .stats-banner {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin: 40px 0;
            flex-wrap: wrap;
        }

        .stat {
            text-align: center;
            color: white;
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 14px;
        }

        /* Dashboard */
        .dashboard {
            background: white;
            border-radius: 16px;
            padding: 40px;
            margin: 20px auto;
            max-width: 1000px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            animation: fadeInUp 0.8s ease;
        }

        .upload-section {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 60px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: var(--light);
        }

        .upload-section:hover {
            border-color: var(--primary);
            background: #f0f1ff;
            transform: translateY(-2px);
        }

        .upload-section.dragover {
            border-color: var(--primary);
            background: #f0f1ff;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-outline {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        /* Results Section */
        .results {
            margin-top: 40px;
            display: none;
        }

        .results.active {
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            animation: slideIn 0.5s ease;
        }

        .summary-card h3 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .summary-card p {
            opacity: 0.9;
            font-size: 14px;
        }

        .subscription-list {
            margin-top: 30px;
        }

        .subscription-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            animation: slideIn 0.5s ease;
        }

        .subscription-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .subscription-info {
            flex: 1;
        }

        .subscription-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .subscription-details {
            color: var(--gray);
            font-size: 14px;
        }

        .subscription-cost {
            font-size: 24px;
            font-weight: bold;
            color: var(--danger);
            margin-right: 20px;
        }

        .subscription-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-potential {
            background: #fef3c7;
            color: #92400e;
        }

        /* Action Buttons */
        .action-section {
            margin-top: 40px;
            padding: 30px;
            background: var(--light);
            border-radius: 12px;
            text-align: center;
        }

        .action-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
        }

        /* Report Section */
        .report-preview {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
        }

        .report-header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
            margin-bottom: 30px;
        }

        .savings-highlight {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin: 30px 0;
        }

        .savings-highlight h2 {
            font-size: 36px;
            margin-bottom: 10px;
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Loading State */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 32px;
            }
            
            .dashboard {
                padding: 20px;
            }
            
            .subscription-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .subscription-cost {
                margin: 10px 0;
            }
        }

        .hidden {
            display: none;
        }

        /* Success message */
        .success-message {
            background: var(--success);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .success-message.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Limited Time Offer Banner -->
    <div id="offerBanner" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; text-align: center; padding: 12px; font-weight: bold; position: fixed; top: 0; width: 100%; z-index: 1000; display: none;">
        üéâ Launch Week Special: 50% OFF Guardian Pro - Only $2.50/month! Ends in <span id="countdown">24:00:00</span>
        <button onclick="showPricingModal()" style="margin-left: 20px; background: white; color: #10b981; padding: 5px 15px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold;">
            Claim Offer
        </button>
        <span onclick="document.getElementById('offerBanner').style.display='none'" style="position: absolute; right: 20px; cursor: pointer;">‚úï</span>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üí≥</div>
                SubtractApp
            </div>
            <div class="nav-buttons">
                <button class="btn btn-outline" onclick="showLogin()">Login</button>
                <button class="btn btn-primary" onclick="showSignup()">Start Free</button>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero" id="heroSection">
        <div class="container">
            <h1>Stop Bleeding Money on Forgotten Subscriptions</h1>
            <p>The average person wastes $273/month on unused subscriptions. Our AI finds and eliminates them in 60 seconds.</p>
            
            <div class="stats-banner">
                <div class="stat">
                    <span class="stat-number">$3,276</span>
                    <span class="stat-label">Avg Yearly Savings</span>
                </div>
                <div class="stat">
                    <span class="stat-number">47K+</span>
                    <span class="stat-label">Subscriptions Found</span>
                </div>
                <div class="stat">
                    <span class="stat-number">12,843</span>
                    <span class="stat-label">Happy Users</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Dashboard -->
    <main class="container">
        <div class="dashboard">
            <!-- Upload Section -->
            <div id="uploadSection">
                <h2 style="text-align: center; margin-bottom: 30px;">Upload Your Bank Statement</h2>
                <div class="upload-section" id="dropZone">
                    <div class="upload-icon">üìÅ</div>
                    <h3>Drop your bank statement here</h3>
                    <p style="margin: 15px 0; color: var(--gray);">Supports CSV, PDF, or any bank export</p>
                    <input type="file" id="fileInput" accept=".csv,.pdf" style="display: none;">
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                        Choose File
                    </button>
                    <p style="margin-top: 20px; font-size: 12px; color: var(--gray);">
                        üîí Bank-level encryption ‚Ä¢ Never stored ‚Ä¢ 100% private
                    </p>
                    <p style="margin-top: 10px; font-size: 12px; color: var(--warning);">
                        ‚ö†Ô∏è This is client-side only. No data leaves your browser. Review sensitive info before upload.
                    </p>
                </div>

                <!-- Demo Button -->
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-outline" onclick="loadDemoData()">
                        ‚ú® Try Demo (No Upload Needed)
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div class="loading" id="loadingSection">
                <div class="spinner"></div>
                <h3>Analyzing Your Subscriptions...</h3>
                <p style="color: var(--gray); margin-top: 10px;">Finding hidden charges and forgotten trials...</p>
            </div>

            <!-- Results Section -->
            <div class="results" id="resultsSection">
                <h2 style="margin-bottom: 30px;">Your Subscription Audit Report</h2>
                
                <!-- Summary Cards -->
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3 id="totalAmount">$0</h3>
                        <p>Monthly Total</p>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                        <h3 id="wastedAmount">$0</h3>
                        <p>Wasted Monthly</p>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <h3 id="savingsAmount">$0</h3>
                        <p>Potential Yearly Savings</p>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <h3 id="subscriptionCount">0</h3>
                        <p>Active Subscriptions</p>
                    </div>
                </div>

                <!-- Subscription List -->
                <div class="subscription-list" id="subscriptionList">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- Action Section -->
                <div class="action-section">
                    <h3>Ready to Save <span id="monthlySavings">$0</span>/month?</h3>
                    <p style="color: var(--gray); margin-top: 10px;">We'll handle all the cancellations for you</p>
                    <div class="action-buttons">
                        <button class="btn btn-success pulse" onclick="showPricingModal()">
                            üéØ Cancel Wasteful Subscriptions
                        </button>
                        <button class="btn btn-primary" onclick="downloadReport()">
                            üìä Download Full Report
                        </button>
                        <button class="btn btn-outline" onclick="scheduleMonitoring()">
                            üîî Monitor Monthly ($5/mo)
                        </button>
                    </div>
                </div>

                <!-- Success Message -->
                <div class="success-message" id="successMessage">
                    ‚úÖ Cancellation requests sent! You'll receive confirmation emails shortly.
                </div>
            </div>
        </div>
    </main>

    <!-- Login/Signup Modal -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">Create Your Account</div>
            <form id="authForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="emailInput" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="passwordInput" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Continue
                </button>
            </form>
            <p style="text-align: center; margin-top: 20px; color: var(--gray); cursor: pointer;" onclick="closeModal()">
                Cancel
            </p>
        </div>
    </div>

    <!-- Pricing Modal -->
    <div class="modal" id="pricingModal">
        <div class="modal-content" style="max-width: 800px;">
            <h2 style="text-align: center; margin-bottom: 30px;">Choose Your Savings Plan</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px;">
                <!-- One-Time Cancellation -->
                <div style="border: 2px solid var(--border); border-radius: 12px; padding: 25px; text-align: center;">
                    <h3 style="color: var(--primary); margin-bottom: 10px;">Quick Cancel</h3>
                    <div style="font-size: 32px; font-weight: bold; margin: 20px 0;">$19</div>
                    <p style="color: var(--gray); font-size: 14px;">One-time service</p>
                    <ul style="text-align: left; margin: 20px 0; list-style: none;">
                        <li style="margin: 10px 0;">‚úÖ We cancel all wasteful subs</li>
                        <li style="margin: 10px 0;">‚úÖ Confirmation report</li>
                        <li style="margin: 10px 0;">‚úÖ Save hours of calls</li>
                        <li style="margin: 10px 0;">‚úÖ Guaranteed cancellation</li>
                    </ul>
                    <button class="btn btn-primary" style="width: 100%;" onclick="processPayment('onetime')">
                        Get Started
                    </button>
                </div>

                <!-- Monthly Monitoring -->
                <div style="border: 2px solid var(--primary); border-radius: 12px; padding: 25px; text-align: center; background: #f0f1ff; position: relative;">
                    <div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px;">
                        MOST POPULAR
                    </div>
                    <h3 style="color: var(--primary); margin-bottom: 10px;">Guardian Pro</h3>
                    <div style="font-size: 32px; font-weight: bold; margin: 20px 0;">
                        $5<span style="font-size: 18px; color: var(--gray);">/mo</span>
                    </div>
                    <p style="color: var(--gray); font-size: 14px;">Continuous protection</p>
                    <ul style="text-align: left; margin: 20px 0; list-style: none;">
                        <li style="margin: 10px 0;">‚úÖ Monthly monitoring</li>
                        <li style="margin: 10px 0;">‚úÖ Auto-detect new charges</li>
                        <li style="margin: 10px 0;">‚úÖ Instant alerts</li>
                        <li style="margin: 10px 0;">‚úÖ Cancel anytime</li>
                        <li style="margin: 10px 0;">‚úÖ Negotiation service</li>
                        <li style="margin: 10px 0;">‚úÖ Savings reports</li>
                    </ul>
                    <button class="btn btn-primary pulse" style="width: 100%;" onclick="processPayment('monthly')">
                        Start Free Trial
                    </button>
                    <p style="font-size: 12px; color: var(--gray); margin-top: 10px;">7-day free trial, then $5/month</p>
                </div>

                <!-- Premium -->
                <div style="border: 2px solid var(--border); border-radius: 12px; padding: 25px; text-align: center;">
                    <h3 style="color: var(--primary); margin-bottom: 10px;">Business</h3>
                    <div style="font-size: 32px; font-weight: bold; margin: 20px 0;">
                        $99<span style="font-size: 18px; color: var(--gray);">/mo</span>
                    </div>
                    <p style="color: var(--gray); font-size: 14px;">For teams & families</p>
                    <ul style="text-align: left; margin: 20px 0; list-style: none;">
                        <li style="margin: 10px 0;">‚úÖ Up to 10 accounts</li>
                        <li style="margin: 10px 0;">‚úÖ Business expense tracking</li>
                        <li style="margin: 10px 0;">‚úÖ API access</li>
                        <li style="margin: 10px 0;">‚úÖ Priority support</li>
                        <li style="margin: 10px 0;">‚úÖ Custom reports</li>
                        <li style="margin: 10px 0;">‚úÖ Dedicated manager</li>
                    </ul>
                    <button class="btn btn-outline" style="width: 100%;" onclick="processPayment('business')">
                        Contact Sales
                    </button>
                </div>
            </div>
            <p style="text-align: center; margin-top: 30px;">
                <span style="color: var(--gray); cursor: pointer;" onclick="closePricingModal()">Maybe later</span>
            </p>
            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                <p style="color: var(--gray); font-size: 14px;">
                    üîí Secure payment by Stripe ‚Ä¢ üí≥ Cancel anytime ‚Ä¢ üí∞ 30-day money-back guarantee
                </p>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal" id="checkoutModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px;">Complete Your Purchase</h3>
            <div id="checkoutDetails"></div>
            <form id="checkoutForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="checkoutEmail" required>
                </div>
                <div class="form-group">
                    <label>Card Number</label>
                    <input type="text" id="cardNumber" placeholder="4242 4242 4242 4242" required>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Expiry</label>
                        <input type="text" id="cardExpiry" placeholder="MM/YY" required>
                    </div>
                    <div class="form-group">
                        <label>CVC</label>
                        <input type="text" id="cardCVC" placeholder="123" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <span id="payButton">Pay Now</span>
                </button>
            </form>
            <p style="text-align: center; margin-top: 20px; color: var(--gray); cursor: pointer;" onclick="closeCheckoutModal()">
                Cancel
            </p>
            <p style="text-align: center; margin-top: 10px; font-size: 12px; color: var(--gray);">
                Powered by Stripe ‚Ä¢ Your payment info is secure and encrypted
            </p>
        </div>
    </div>

    <script type="module">
        import * as pdfjsLib from 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.mjs';
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.worker.min.mjs';

        // Global state
        let transactions = [];
        let subscriptions = [];
        let userData = null;

        // Common subscription mappings
        const commonSubs = {
            'netflix': { name: 'Netflix', category: 'Entertainment', cancelUrl: 'https://www.netflix.com/youraccount' },
            'spotify': { name: 'Spotify', category: 'Music', cancelUrl: 'https://www.spotify.com/account/subscriptions/' },
            'amazon prime': { name: 'Amazon Prime', category: 'Shopping', cancelUrl: 'https://www.amazon.com/gp/primecentral' },
            'adobe': { name: 'Adobe Creative Cloud', category: 'Software', cancelUrl: 'https://account.adobe.com/plans' },
            'hulu': { name: 'Hulu', category: 'Entertainment', cancelUrl: 'https://www.hulu.com/account' },
            'gym': { name: 'Gym Membership', category: 'Fitness', cancelUrl: '' }, // Generic, no specific URL
            'linkedin premium': { name: 'LinkedIn Premium', category: 'Professional', cancelUrl: 'https://www.linkedin.com/psettings/premium-subscription' },
            'dropbox': { name: 'Dropbox Plus', category: 'Storage', cancelUrl: 'https://www.dropbox.com/account/plan' },
            'medium': { name: 'Medium Membership', category: 'Reading', cancelUrl: 'https://medium.com/me/membership' },
            'disney': { name: 'Disney+', category: 'Entertainment', cancelUrl: 'https://www.disneyplus.com/account' },
            'apple icloud': { name: 'Apple iCloud+', category: 'Storage', cancelUrl: 'https://support.apple.com/en-us/HT201238' },
            'canva': { name: 'Canva Pro', category: 'Design', cancelUrl: 'https://www.canva.com/settings/billing' },
            'grammarly': { name: 'Grammarly Premium', category: 'Writing', cancelUrl: 'https://www.grammarly.com/profile/subscription' },
            'masterclass': { name: 'Masterclass', category: 'Education', cancelUrl: 'https://www.masterclass.com/settings/subscriptions' },
            // Add more as needed
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupDragAndDrop();
            setupFileInput();
            checkAuth();
        });

        // Check if user is logged in
        function checkAuth() {
            const user = sessionStorage.getItem('subtractUser');
            if (user) {
                userData = JSON.parse(user);
                updateAuthButtons();
            }
        }

        // Update auth buttons based on login state
        function updateAuthButtons() {
            const navButtons = document.querySelector('.nav-buttons');
            if (userData) {
                navButtons.innerHTML = `
                    <span style="margin-right: 15px;">Welcome, ${userData.email}</span>
                    <button class="btn btn-outline" onclick="logout()">Logout</button>
                `;
            }
        }

        // Setup drag and drop
        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                handleFile(e.dataTransfer.files[0]);
            });
        }

        // Setup file input
        function setupFileInput() {
            document.getElementById('fileInput').addEventListener('change', (e) => {
                handleFile(e.target.files[0]);
            });
        }

        // Handle file upload
        function handleFile(file) {
            if (!file) return;
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                alert('File too large. Max 10MB.');
                return;
            }
            if (!['text/csv', 'application/pdf'].includes(file.type)) {
                alert('Unsupported file type. Please upload CSV or PDF.');
                return;
            }

            showLoading();
            const reader = new FileReader();

            reader.onerror = () => {
                alert('Error reading file.');
                hideLoading();
            };

            if (file.type === 'text/csv') {
                reader.readAsText(file);
                reader.onload = (e) => {
                    try {
                        const data = Papa.parse(e.target.result, { header: true, skipEmptyLines: true });
                        transactions = data.data.map(row => ({
                            date: new Date(row.Date || row['Transaction Date'] || row['Posting Date'] || ''),
                            desc: (row.Description || row.Memo || row['Transaction Details'] || '').toLowerCase().trim(),
                            amount: parseFloat(row.Amount || row.Debit || row['Withdrawal Amount'] || 0)
                        })).filter(t => !isNaN(t.date.getTime()) && t.amount < 0); // Debits are negative
                        detectSubscriptions();
                        showResults();
                    } catch (err) {
                        alert('Error parsing CSV: ' + err.message);
                        hideLoading();
                    }
                };
            } else if (file.type === 'application/pdf') {
                reader.readAsArrayBuffer(file);
                reader.onload = async (e) => {
                    try {
                        const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(e.target.result) }).promise;
                        let text = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            text += content.items.map(item => item.str).join(' ') + '\n';
                        }
                        // Improved parse: look for patterns like date desc amount
                        const lines = text.split('\n').filter(line => line.trim());
                        transactions = lines.map(line => {
                            // Flexible regex for date (MM/DD/YYYY or DD/MM/YYYY), desc, amount (negative for debits)
                            const match = line.match(/(\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4})\s+(.*?)\s+(-?\$?\d{1,3}(?:,\d{3})*\.\d{2})/);
                            if (match) {
                                return {
                                    date: new Date(match[1]),
                                    desc: match[2].toLowerCase().trim(),
                                    amount: parseFloat(match[3].replace(/[^0-9.-]/g, ''))
                                };
                            }
                            return null;
                        }).filter(t => t && !isNaN(t.date.getTime()) && t.amount < 0);
                        detectSubscriptions();
                        showResults();
                    } catch (err) {
                        alert('Error extracting from PDF: ' + err.message + '. Try exporting to CSV for better accuracy.');
                        hideLoading();
                    }
                };
            }
        }

        function hideLoading() {
            document.getElementById('loadingSection').classList.remove('active');
            document.getElementById('uploadSection').style.display = 'block';
        }

        // Detect subscriptions
        function detectSubscriptions() {
            subscriptions = [];
            const groups = {};
            transactions.forEach(t => {
                let key = t.desc.replace(/\d+/g, '').trim(); // Normalize by removing numbers
                if (!groups[key]) groups[key] = [];
                groups[key].push(t);
            });

            Object.entries(groups).forEach(([key, txs]) => {
                if (txs.length < 2) return;
                txs.sort((a, b) => a.date - b.date);
                const diffs = [];
                for (let i = 1; i < txs.length; i++) {
                    diffs.push((txs[i].date - txs[i-1].date) / (1000 * 60 * 60 * 24)); // days
                }
                const avgDiff = diffs.reduce((sum, d) => sum + d, 0) / diffs.length;
                const avgCost = Math.abs(txs.reduce((sum, t) => sum + t.amount, 0) / txs.length);

                if (avgDiff > 25 && avgDiff < 35 && avgCost > 1) { // Monthly-ish, min $1
                    const matchKey = Object.keys(commonSubs).find(k => key.includes(k));
                    const match = matchKey ? commonSubs[matchKey] : null;
                    subscriptions.push({
                        name: match ? match.name : key.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '),
                        cost: avgCost,
                        category: match ? match.category : 'Other',
                        status: 'potential',
                        lastUsed: txs[txs.length - 1].date.toLocaleDateString(),
                        cancelUrl: match ? match.cancelUrl : null
                    });
                }
            });
        }

        // Load demo data
        function loadDemoData() {
            showLoading();
            setTimeout(() => {
                // Sample transactions for demo
                transactions = [
                    { date: new Date('2023-01-01'), desc: 'netflix', amount: -15.99 },
                    { date: new Date('2023-02-01'), desc: 'netflix', amount: -15.99 },
                    { date: new Date('2023-01-05'), desc: 'spotify premium', amount: -9.99 },
                    { date: new Date('2023-02-05'), desc: 'spotify premium', amount: -9.99 },
                    // Add more for demo
                ];
                detectSubscriptions();
                showResults();
            }, 2000);
        }

        // Show loading state
        function showLoading() {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('loadingSection').classList.add('active');
            document.getElementById('resultsSection').classList.remove('active');
        }

        // Show results
        function showResults() {
            document.getElementById('loadingSection').classList.remove('active');
            document.getElementById('resultsSection').classList.add('active');
            
            // Calculate totals
            const total = subscriptions.reduce((sum, sub) => sum + sub.cost, 0);
            const wasted = 0; // No auto 'wasted' detection; user reviews
            const yearlySavings = total * 12; // Potential if all canceled
            document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
            document.getElementById('wastedAmount').textContent = `$${wasted.toFixed(2)}`;
            document.getElementById('savingsAmount').textContent = `$${yearlySavings.toFixed(0)}`;
            document.getElementById('subscriptionCount').textContent = subscriptions.length;
            document.getElementById('monthlySavings').textContent = `$${total.toFixed(2)}`; // Potential
            
            // Render subscription list
            renderSubscriptions();
            
            // Show offer banner after analysis
            showOfferAfterAnalysis();
        }

        // Render subscription list
        function renderSubscriptions() {
            const listContainer = document.getElementById('subscriptionList');
            listContainer.innerHTML = '<h3 style="margin-bottom: 20px;">Potential Subscriptions Found</h3>';
            
            subscriptions.forEach((sub, index) => {
                const statusClass = `status-${sub.status}`;
                const statusText = 'Potential';
                
                const item = document.createElement('div');
                item.className = 'subscription-item';
                item.style.animationDelay = `${index * 0.1}s`;
                
                item.innerHTML = `
                    <div class="subscription-info">
                        <div class="subscription-name">${sub.name}</div>
                        <div class="subscription-details">
                            ${sub.category} ‚Ä¢ Last charge: ${sub.lastUsed}
                        </div>
                    </div>
                    <div class="subscription-cost">$${sub.cost.toFixed(2)}</div>
                    <div class="subscription-status ${statusClass}">${statusText}</div>
                `;
                
                if (sub.cancelUrl) {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'btn btn-danger';
                    cancelBtn.textContent = 'Cancel Guide';
                    cancelBtn.onclick = () => window.open(sub.cancelUrl, '_blank');
                    item.appendChild(cancelBtn);
                }
                
                listContainer.appendChild(item);
            });
        }

        // Show pricing modal
        function showPricingModal() {
            document.getElementById('pricingModal').classList.add('active');
            
            // Track event
            if (typeof gtag !== 'undefined') {
                gtag('event', 'view_pricing', {
                    'event_category': 'engagement',
                    'event_label': 'pricing_modal_opened'
                });
            }
        }

        // Close pricing modal
        function closePricingModal() {
            document.getElementById('pricingModal').classList.remove('active');
        }

        // Process payment
        function processPayment(plan) {
            const stripeLinks = {
                onetime: 'https://buy.stripe.com/YOUR_ONETIME_LINK', // Replace with your actual Stripe payment link
                monthly: 'https://buy.stripe.com/YOUR_MONTHLY_LINK' // Replace with your actual Stripe payment link
            };
            
            if (plan === 'business') {
                window.location.href = 'mailto:enterprise@subtractapp.com';
                return;
            }
            
            const link = stripeLinks[plan];
            if (link.includes('YOUR_')) {
                alert('Payment link not configured. Please set up in Stripe Dashboard.');
                return;
            }
            
            window.location.href = link;
        }

        // Download report
        function downloadReport() {
            const report = generateReport();
            const blob = new Blob([report], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'subscription-audit-report.html';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Generate HTML report
        function generateReport() {
            const total = subscriptions.reduce((sum, sub) => sum + sub.cost, 0);
            
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Subscription Audit Report - SubtractApp</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
                        h1 { color: #6366f1; }
                        .summary { background: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
                        th { background: #f9fafb; font-weight: bold; }
                        .status-potential { color: #92400e; }
                    </style>
                </head>
                <body>
                    <h1>Subscription Audit Report</h1>
                    <p>Generated on ${new Date().toLocaleDateString()}</p>
                    
                    <div class="summary">
                        <h2>Summary</h2>
                        <p><strong>Total Monthly Cost:</strong> $${total.toFixed(2)}</p>
                        <p><strong>Potential Yearly Savings (if canceled):</strong> $${(total * 12).toFixed(2)}</p>
                        <p><strong>Total Potential Subscriptions:</strong> ${subscriptions.length}</p>
                    </div>
                    
                    <h2>Subscription Details</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th>Category</th>
                                <th>Monthly Cost</th>
                                <th>Status</th>
                                <th>Last Charge</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${subscriptions.map(sub => `
                                <tr>
                                    <td>${sub.name}</td>
                                    <td>${sub.category}</td>
                                    <td>$${sub.cost.toFixed(2)}</td>
                                    <td class="status-${sub.status}">${sub.status}</td>
                                    <td>${sub.lastUsed}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 40px; padding: 20px; background: #10b981; color: white; border-radius: 8px; text-align: center;">
                        <h2>Review and Cancel to Save!</h2>
                        <p>Visit SubtractApp.com for more tools</p>
                    </div>
                </body>
                </html>
            `;
        }

        // Schedule monitoring
        function scheduleMonitoring() {
            if (!userData || userData.plan !== 'monthly') {
                showPricingModal();
                return;
            }
            
            alert('‚úÖ Monthly monitoring activated! We\'ll scan your subscriptions on the 1st of each month and alert you to any new or suspicious charges.');
        }

        // Auth functions
        function showLogin() {
            document.getElementById('modalTitle').textContent = 'Login to Your Account';
            document.getElementById('authModal').classList.add('active');
        }

        function showSignup() {
            document.getElementById('modalTitle').textContent = 'Create Your Account';
            document.getElementById('authModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('authModal').classList.remove('active');
        }

        function logout() {
            sessionStorage.removeItem('subtractUser');
            userData = null;
            location.reload();
        }

        // Handle auth form submission
        document.getElementById('authForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            
            // Simple auth simulation (in production, use real auth)
            if (password.length < 6) {
                alert('Password too short.');
                return;
            }
            userData = { email, id: Date.now() };
            sessionStorage.setItem('subtractUser', JSON.stringify(userData));
            
            closeModal();
            updateAuthButtons();
            
            alert('‚úÖ Account created successfully! You now have access to premium features.');
        });

        // Additional init
        document.addEventListener('DOMContentLoaded', () => {
            // Animate stats
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('pulse');
                    }
                });
            });
            
            document.querySelectorAll('.stat-number').forEach(el => observer.observe(el));
            
            // Countdown
            let timeLeft = 24 * 60 * 60;
            function updateCountdown() {
                const hours = Math.floor(timeLeft / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                const seconds = timeLeft % 60;
                const countdownEl = document.getElementById('countdown');
                if (countdownEl) {
                    countdownEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                if (timeLeft > 0) timeLeft--;
            }
            setInterval(updateCountdown, 1000);
            
            // Show banner after 5s
            setTimeout(() => {
                const banner = document.getElementById('offerBanner');
                if (banner && !sessionStorage.getItem('offerDismissed')) {
                    banner.style.display = 'block';
                    document.body.style.paddingTop = '50px';
                }
            }, 5000);
        });
        
        // Show offer after analysis
        function showOfferAfterAnalysis() {
            setTimeout(() => {
                const banner = document.getElementById('offerBanner');
                if (banner && !userData) {
                    banner.style.display = 'block';
                    document.body.style.paddingTop = '50px';
                }
            }, 3000);
        }
    </script>
</body>
</html>
